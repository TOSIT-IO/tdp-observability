# Copyright 2022 TOSIT.IO
# SPDX-License-Identifier: Apache-2.0

---
#######################################################################
# TEMPORARY                                                           #
# Remove after the vars are tracked in tdp_vars_defaults/tdp_cluster  #
#######################################################################

# Cluster name
cluster_name: mycluster

#######################################################################
# TEMPORARY                                                           #
# Remove after the vars are tracked in tdp_vars_defaults/tdp_cluster  #
#######################################################################

# Grafana ports
grafana_web_port: 3000

# Prometheus ports
prometheus_web_port: 9090

# Prometheus basicAuth
prometheus_admin_user: admin
prometheus_admin_password: PrometheusAdmin123

# Promtail ports
promtail_web_port: 9080
promtail_grpc_port: 9095

# Loki ports
loki_web_port: 3100
loki_grpc_port: 9096

# Node Exporter port
exporter_node_http_port: 9100

# Postgres Exporter port
exporter_postgres_http_port: 9187

#################################
# Service & Component logs dirs #
#################################
node_exporter_log_dir: /var/log/node-exporter
node_exporter_log_file: node-exporter.log

postgres_exporter_log_dir: /var/log/postgres-exporter
postgres_exporter_log_file: postgres-exporter.log

grafana_log_dir: /var/log/grafana
grafana_log_file: "grafana.log"     # do not change. Grafana forces this filename. Variable is here only for promtail

promtail_log_dir: /var/log/promtail
promtail_log_file: promtail.log

loki_log_dir: /var/log/loki
loki_log_file: loki.log

prometheus_log_dir: /var/log/prometheus
prometheus_log_file: prometheus.log

observability_common_labels: {}
#  cluster: "{{ cluster_name }}"

#
# observability_tdp_targets structure :
# service_name
#    +--- component_name
#              +---- group : name of the ansible group that runs this component.
#              |             Optional : should be specified only if not equal
#              |             to '{{ service_name }}_{{ component_name }}'
#              +---- jobs  : list of scrape jobs to configure
#                            each job has the following entries :
#
# - exporter_port     : exporter service port (empty to monitor only logs)
# - log_file          : log file path (empty to monitor only prometheus exporter)
# - name_suffix       : mandatory if more than one job
#                       job_name in prometheus or promtail scrapes will be
#                       equal to '{{ service }}_{{ component }}_{{ suffix }}
# - promtail_pipeline : pipeline to use. One of :
#                       - string : will be considered as a key in
#
dashboard_with_workers: "service02/service-components-and-workers"
dashboard_without_workers: "service01/service-components"

observability_tdp_targets:
  hbase:
    labels:
      type: tdp_core
      svc_dashboard: "{{ dashboard_with_workers }}"
    master:
      jobs:
        - exporter_port: "{{ exporter_hbase_hm_http_port }}"
          log_file: "{{ hbase_log_dir }}/{{ hbase_hm_log_file }}"
    region_server:
      group: hbase_rs
      labels: { 'worker': 'True' }
      jobs:
        - exporter_port: "{{ exporter_hbase_hrs_http_port }}"
          log_file: "{{ hbase_log_dir }}/{{ hbase_hrs_log_file }}"
    rest:
      jobs:
        - exporter_port: "{{ exporter_hbase_hr_http_port }}"
          log_file: "{{ hbase_log_dir }}/{{ hbase_hr_log_file }}"
    phoenix_queryserver_daemon:
      group: phoenix_queryserver_daemon
      jobs:
        - exporter_port: "{{ exporter_hbase_pqs_http_port }}"
          log_file: "{{ phoenix_log_dir }}/{{ phoenix_queryserver_log_file }}"
  hdfs:
    labels:
      type: tdp_core
      svc_dashboard: "{{ dashboard_with_workers }}"
    datanode:
      group: hdfs_dn
      labels: { 'worker': 'True' }
      jobs:
        - exporter_port: "{{ exporter_hdfs_dn_http_port }}"
          log_file: "{{ hdfs_log_dir }}/{{ hadoop_hdfs_datanode_log_file }}"
    journal_node:
      group: hdfs_jn
      jobs:
        - exporter_port: "{{ exporter_hdfs_jn_http_port }}"
          log_file: "{{ hdfs_log_dir }}/{{ hadoop_hdfs_journalnode_log_file }}"
    namenode:
      group: hdfs_nn
      jobs:
        - exporter_port: "{{ exporter_hdfs_nn_http_port }}"
          logfile: "{{ hdfs_log_dir }}/{{ hadoop_hdfs_namenode_log_file }}"
        - name_suffix: zkfc
          exporter_port: "{{ exporter_hdfs_zkfc_http_port }}"
          log_file: "{{ hdfs_log_dir }}/{{ hadoop_hdfs_zkfc_log_file }}"
    httpfs:
      jobs:
        - log_file: "{{ hdfs_log_dir }}/{{ hadoop_hdfs_httpfs_log_file }}"
          exporter_port: "{{ exporter_hdfs_httpfs_http_port }}"
  hive:
    labels:
      type: tdp_core
      svc_dashboard: "{{ dashboard_without_workers }}"
    metastore:
      group: hive_ms
      jobs:
        - exporter_port: "{{ exporter_hive_hms_http_port }}"
          log_file: "{{ hive_log_dir }}/{{ hive_ms_log_file }}"
    server2s:
      group: hive_s2
      jobs:
        - exporter_port: "{{ exporter_hive_hs2_http_port }}"
          log_file: "{{ hive_log_dir }}/{{ hive_s2_log_file }}"
  knox:
    labels:
      type: tdp_core
      svc_dashboard: "{{ dashboard_without_workers }}"
    gateway:
      group: knox
      jobs:
        - exporter_port: "{{ exporter_knox_gateway_http_port }}"
          log_file: "{{ knox_log_dir }}/{{ knox_gateway_log_file }}"
  ranger:
    labels:
      type: tdp_core
      svc_dashboard: "{{ dashboard_without_workers }}"
    admin:
      jobs:
        - exporter_port: "{{ exporter_ranger_ra_http_port }}"
          log_file: "{{ ranger_log_dir }}/{{ ranger_admin_log_file }}"
    usersync:
      jobs:
        - exporter_port: "{{ exporter_ranger_ru_http_port }}"
          log_file: "{{ ranger_log_dir }}/{{ ranger_usersync_log_file }}"
    key_management_service:
      group: ranger_kms
      jobs:
        - exporter_port: "{{ exporter_ranger_kms_http_port }}"
          log_file: "{{ ranger_kms_log_dir }}/{{ ranger_kms_log_file }}"
    solr:
      jobs:
        - log_file: "{{ ranger_log_dir }}/{{ ranger_solr_log_file }}"
  spark2:
    labels:
      type: tdp_core
      svc_dashboard: "{{ dashboard_without_workers }}"
    history_server:
      group: spark_hs
      jobs:
        - log_file: "{{ spark2_log_dir }}/{{ spark2_hs_log_file }}"
          exporter_port: "{{ exporter_spark_hs_http_port }}"
  spark3:
    labels:
      type: tdp_core
      svc_dashboard: "{{ dashboard_without_workers }}"
    history_server:
      group: spark3_hs
      jobs:
        - log_file: "{{ spark3_log_dir }}/{{ spark3_hs_log_file }}"
          exporter_port: "{{ exporter_spark3_hs_http_port }}"
  yarn:
    labels:
      type: tdp_core
      svc_dashboard: "{{ dashboard_with_workers }}"
    ressource_manager:
      group: yarn_rm
      jobs:
        - exporter_port: "{{ exporter_yarn_rm_http_port }}"
          log_file: "{{ yarn_log_dir }}/{{ hadoop_yarn_resourcemanager_log_file }}"
    mapred_history_server:
      group: mapred_jhs
      jobs:
        - exporter_port: "{{ exporter_mapred_jhs_http_port }}"
          log_file: "{{ mapred_log_dir }}/{{ hadoop_mapred_historyserver_log_file }}"
    node_manager:
      labels: { 'worker': 'True' }
      group: yarn_nm
      jobs:
        - exporter_port: "{{ exporter_yarn_nm_http_port }}"
          log_file: "{{ yarn_log_dir }}/{{ hadoop_yarn_nodemanager_log_file }}"
    timeline_server:
      group: yarn_ats
      jobs:
        - exporter_port: "{{ exporter_yarn_ats_http_port }}"
          log_file: "{{ yarn_log_dir }}/{{ hadoop_yarn_timelineserver_log_file }}"
  zookeeper:
    labels:
      type: tdp_core
      svc_dashboard: "{{ dashboard_without_workers }}"
    server:
      group: zk
      jobs:
        - exporter_port: "{{ exporter_zookeeper_server_http_port }}"
          log_file: "{{ zookeeper_log_dir }}/{{ zookeeper_log_file }}"
        - name_suffix: trace
          log_file: "{{ zookeeper_log_dir }}/{{ zookeeper_tracelog_file }}"
  #
  # Observability
  #
  grafana:
    labels:
      type: tdp_observability
    server:
      group: grafana
      jobs:
        - log_file: "{{ grafana_log_dir }}/{{ grafana_log_file }}"
          promtail_pipeline:
            - logfmt:
                mapping:
                  datetime: t
                  level:
            - timestamp:
                format: 'RFC3339'
                source: 'datetime'
            - labels:
                level: ''
  exporter:
    node:
      jobs:
        - exporter_port: "{{ exporter_node_http_port }}"
          labels:
            type: tdp_infra
        - log_file: "{{ node_exporter_log_dir }}/{{ node_exporter_log_file }}"
          promtail_pipeline: observability
          labels:
            type: tdp_observability
    postgres:
      jobs:
        - log_file: "{{ postgres_exporter_log_dir }}/{{ postgres_exporter_log_file }}"
          promtail_pipeline: observability
          labels:
            type: tdp_observability
        - exporter_port: "{{ exporter_postgres_http_port }}"
          labels:
            type: tdp_infra
  prometheus:
    server:
      group: prometheus
      jobs:
        - log_file: "{{ prometheus_log_dir }}/{{ prometheus_log_file }}"
          promtail_pipeline: observability
          labels:
            type: tdp_observability
  loki:
    server:
      group: loki
      jobs:
        - log_file: "{{ loki_log_dir }}/{{ loki_log_file }}"
          promtail_pipeline: observability
          labels:
            type: tdp_observability
    promtail:
      group: promtail
      jobs:
        - log_file: "{{ promtail_log_dir }}/{{ promtail_log_file }}"
          promtail_pipeline: observability
          labels:
            type: tdp_observability
